{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}

<form class='form postForm' method='POST' enctype='multipart/form-data'>
	{% csrf_token %}
	{{ form|crispy }}
	{{ formset|crispy}}
        <input type="text" id="txtautocomplete" style="width:200px" placeholder="{{ form.instance.location }}" />
        <button class="primaryAction btn btn-success" type="submit">Submit</button>
</form>

{% endblock content %}

{% block extra_js %}
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD52gtDK6h64U9oRPhszZvDYKobM7ieII0&libraries=places"></script>

<script type='text/javascript'>

	var itemCity = '';
        var itemPc='';
        var itemState = '';
        var itemCountry='';
        var itemAddress= '';
        var itemLat = 0.0;
        var itemLng = 0.0;

	function getCookie(name) {
		var cookieValue = null;
    		if (document.cookie && document.cookie !== '') {
        		var cookies = document.cookie.split(';');
        		for (var i = 0; i < cookies.length; i++) {
                		var cookie = jQuery.trim(cookies[i]);
            			// Does this cookie string begin with the name we want?
        	    		if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                		cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                			break;
            			}
        		}
    		}
    		return cookieValue;
	}

	var csrftoken = getCookie('csrftoken');

	function csrfSafeMethod(method) {
    		// these HTTP methods do not require CSRF protection
    		return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}
	$.ajaxSetup({
    		beforeSend: function(xhr, settings) {
        		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            			xhr.setRequestHeader("X-CSRFToken", csrftoken);
        		}
    		}
	});


	//AJAX create post function
	function create_post(local, data){
		console.log('inside create post function')
		var f = $('.postForm').serialize() + '&loc=' + local;
	        console.log(f)	


		$.ajax({
			url : "{% url 'posts:ajax_post' %}",
			type: "POST",
			data: data + '&loc=' + local,
			enctype: 'multipart/form-data',			

			success : function(json) {
			//$(location).attr('href', json['url']);
			},
			error : function(xhr, errmsg, err) {
				$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+" <a href='#' class='close'>&times;</a></div>")
				console.log(xhr.status + ': ' + xhr.responseText);
			}	
		});
	};



	//AJAX get location function
        function get_location() {
        var data = { 
					{% if form.instance.id %}id: {{form.instance.id}},{% endif %}
					city    : itemCity,
					state   : itemState,
					country :itemCountry,
					lat     : itemLat,
					lng     : itemLng
					};
		var form = $('.postForm').serialize();
		console.log('now inside get_location');
		$.ajax({
			url  : "{% url 'posts:ajax_location' %}",
			type : 'POST',
			data : form + '&' + $.param(data),
			success : function(json) {
				console.log('success call')
				if (json['status'] = 'Update Post') {
					$(location).attr('href', json['url']);
				} 
				if (json['status'] = 'Create Post') {
					local = json['location']
					create_post(local, form);
				}
			},
			error : function(xhr, errmsg, err) {
				$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+" <a href='#' class='close'>&times;</a></div>")
				console.log(xhr.status + ': ' + xhr.responseText);
			}
		});
	};



    google.maps.event.addDomListener(window, 'load', intilize);
        function intilize() {
                var autocomplete = new google.maps.places.Autocomplete(document.getElementById('txtautocomplete'));

                        google.maps.event.addListener(autocomplete, 'place_changed', function () {

                                var place = autocomplete.getPlace();
                                var arrAddress = place.address_components;

                                itemLat = place.geometry.location.lat();
                                itemLng = place.geometry.location.lng();                      

                                // iterate through address_component array
                                $.each(arrAddress, function (i, address_component) {

                                    if (address_component.types[0] == "locality"){
                                        itemCity = address_component.long_name;
                                    }

                                    if (address_component.types[0] == "country"){ 
                                        itemCountry = address_component.short_name;
                                    }

                                    if (address_component.types[0] == "administrative_area_level_1"){ 
                                        itemState = address_component.short_name;
                                    }

                                    if (address_component.types[0] == "postal_code"){ 
                                        itemPc = address_component.long_name;
                                    }
                                    //return false; // break the loop   
                                });
		});
        };

	$(document).ready(function(){
		$('form').on('submit', function(event){
			event.preventDefault();
			var form = $('.postForm');
			console.log('form submitted!')
			get_location();
		});
	});
</script>
{% endblock extra_js%}


